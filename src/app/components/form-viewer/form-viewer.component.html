<div class="viewer-container-wrapper">
  <div class="viewer-container-header flex">
    <div class="form-name">
      <span>
        <button mat-button (click)="router.navigate(['/forms']);">
          <mat-icon>chevron_left</mat-icon>
          Back
        </button>
      </span>
      <span class="margin-md">{{ activeFormSummary?.formName }}</span>
    </div>
    @if (activeFormSummary?.patientSummary) {
      <div class="patient-details">
        <app-patient-details [patientSummary]="activeFormSummary?.patientSummary"/>
      </div>
    }
  </div>
  <div class="viewer-container-body">
    @if (!activeFormSummary) {
      <div class="viewer-container-body-content">
        <div class="margin-md">No form has been selected, please load an active form through the Form Manager.</div>
        <div class="margin-md">
          <button mat-raised-button (click)="selectPatientForm()">Go to Form Manager</button>
        </div>
      </div>
    } @else {
      <div class="padding-right-md">
        <mat-nav-list class="side-nav">
          @for (item of temp_for_demo?.["item"]; track item; let i = $index) {
            <div>
              <button
                mat-flat-button
                class="expanded-menu-button"
                [ngClass]="(i == selectedMenuItemIndex) ? 'selected-menu-item': ''"
                (click)="selectQuestionnaireSection(item, i); this.selectedEvidenceIndex = null; showDrawer=false">
                {{ item["text"] }}
              </button>
            </div>
          }
        </mat-nav-list>
      </div>

      <!-- Begin actual form rendering -->
      <div class="viewer-container-body-content">
        @for (item of temp_for_demo?.["item"]; track item) {
          @if (item["selected"]) {
            <div class="margin-top-md item-text">{{ item["text"] }}</div>

            @for (childItem of item["item"]; track childItem; let i = $index) {
              <div class="question-item"
                   [ngClass]="(i == selectedEvidenceIndex && showDrawer) ? 'selected-evidence': ''">
                <div class="question-label margin-top-md">
                  <mat-label>{{ i + 1 }}. {{ childItem["text"] }}</mat-label>
                </div>

                <div>
                  @if (childItem["type"] == QuestionWidgetType.RADIO) {
                    @for (option of childItem?.['answerOption']; track option) {
                      <mat-radio-group [(ngModel)]="childItem['value']">
                        @if (childItem?.['answerOption'].length <= 3) {
                          <mat-radio-button class="margin-right-md" [value]="option">{{ option?.['valueString'] }}
                          </mat-radio-button>
                        } @else {
                          <!-- There are too many options to render in the same line -->
                          <div>
                            <mat-radio-button [value]="option">{{ option?.['valueString'] }}</mat-radio-button>
                          </div>
                        }
                      </mat-radio-group>
                    }
                  } @else if (childItem["type"] == QuestionWidgetType.INPUT) {
                    <mat-form-field appearance="outline" class="margin-top-sm">
                      <input type="text" matInput [(ngModel)]="childItem['answer']">
                    </mat-form-field>
                  }

                  @for (extension of childItem['extension']; track extension) {
                    @if (extension?.url == "http://gtri.gatech.edu/fakeFormIg/nlpqlTask" || extension?.url == "http://gtri.gatech.edu/fakeFormIg/cqlTask") {
<!--                      TODO: Handle status based scenarios per logic below                 -->
<!--                      if hasLogic                                                         -->
<!--                        if results[linkId} is found                                       -->
<!--                          if cqlAnswer                                                    -->
<!--                            show suggested answer                                         -->
<!--                          if evidence                                                     -->
<!--                            show evidence button                                          -->
<!--                      else results[linkId] not found AND if results.status is in progress -->
<!--                          show progress spinner                                           -->
<!--                      else results[linkId] not found AND if results.status is complete    -->
<!--                      show "No evidence found"                                            -->

                      @if ((this.results$ | async)?.["link" + childItem?.["linkId"]]?.["cqlAnswer"]?.["valueString"]){
                        <div class="margin-left-md margin-bottom-sm">
                          Suggested Answer: {{ (this.results$ | async)?.["link" + childItem?.["linkId"]]?.["cqlAnswer"]?.["valueString"] ? (this.results$ | async)?.["link" + childItem?.["linkId"]]?.["cqlAnswer"]?.["valueString"] : "ERROR"}}
                        </div>
                      }

                      @if ((this.results$ | async)?.["link" + childItem?.["linkId"]]?.["evidence"] && (this.results$ | async)?.["link" + childItem?.["linkId"]]?.["evidence"].length > 0) {
                        <button mat-raised-button
                                appHasEvidence [extensionList]="childItem['extension']"
                                appSetEvidence [evidenceList]="(this.results$ | async)?.['link' + childItem?.['linkId']]?.['evidence']"
                                (click)="showDrawer=true">
                          View Evidence ({{(this.results$ | async)?.["link" + childItem?.["linkId"]]?.["evidence"] ? (this.results$ | async)?.["link" + childItem?.["linkId"]]?.["evidence"]?.length : "ERROR"}})
                        </button>
                      }
                    }
                  }

                </div>
              </div>
            }
          }
        }
        <button mat-raised-button type="submit" (click)="onSubmit()">Submit</button>
      </div>
      <div class="viewer-container-body-side-content viewer-container-body-side-fhir-explorer"
           [hidden]="!showDrawer">
        <div class="fhir-explorer-header">
          <span class="explorer-header-title">
            Evidence
          </span>
          <span class="content-spacer"></span>
          <mat-icon (click)="showDrawer = false;"
                    aria-label="Close Evidence Viewer"
                    matTooltip="Close Evidence Viewer"
                    class="pointer">
            close
          </mat-icon>
        </div>
        <app-evidence-details></app-evidence-details>
      </div>
    }

    <!--    @if (temp_for_demo) {-->
    <!--      <ul>-->
    <!--        @for (item of temp_for_demo["item"]; track item) {-->
    <!--          <li>{{ item["text"] }}-->
    <!--            <ul>-->
    <!--              @for (childItem of item["item"]; track childItem) {-->
    <!--                <li>{{ childItem["text"] }} - {{ childItem["type"] }}</li>-->
    <!--              }-->
    <!--            </ul>-->
    <!--            }-->
    <!--      </ul>-->
    <!--    }-->

  </div>
</div>
